<!DOCTYPE html>
<html lang="utf8">
<head>
    <title>自动化巡检测试系统-用例管理</title>

    <link href="/component/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/main.css" rel="stylesheet">
    <link href="/css/loader.css" rel="stylesheet">
</head>
<body>
<div id="wrapper">
    <div id="sidebar-wrapper" >
        <ul class="sidebar-nav">
            <li class="sidebar-brand"><a href="/">自动巡检测试系统</a></li>
            <li id="menu_tree">
                <span id="case_list"></span>
            </li>
        </ul>
    </div>

    <div id="use_case-wrapper">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/use_case/1">用例管理</a></li>
                <li class="breadcrumb-item active" aria-current="page">自动化用例</li>
            </ol>
        </nav>
        <button id="add_use_case" class="btn btn-primary btn-sm" role="button" style="margin-bottom: 20px; margin-left: 1%" value="">新增用例</button>

        <HR id="head_line" style="display: none">

        <div id="loader_use_case"></div>
        <div id="error_alert_use_case" class="alert alert-danger" role="alert"></div>

        <table class="table" id="use_case_table">
            <thead>
            <tr>
                <th scope="col">#</th>
                <th scope="col">用例名称</th>
                <th scope="col">类型</th>
                <th scope="col">创建者</th>
                <th scope="col">更新时间</th>
                <th scope="col">模块名称</th>
                <th scope="col">操作</th>
            </tr>
            </thead>
            <tbody>
            </tbody>
        </table>

        <nav aria-label="Page navigation">
            <ul class="pagination">
                <li class="page-item" id="previous_page"><a class="page-link" href="#">上一页</a></li>
                <li class="page-item" id="next_page"><a class="page-link" href="#">下一页</a></li>
                <input id="input_page" onchange="pageChange(this)" value=""/>
                <button id="jump_page" class="btn btn-primary btn-sm"
                        style="height: 35px" data-page_num="" data-time_url="">跳转</button>
            </ul>
        </nav>
    </div>

    <div id="page-content-wrapper" style="display: none">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/use_case/1">用例管理</a></li>
                <li class="breadcrumb-item active" aria-current="page">自动化用例</li>
            </ol>
        </nav>
        <HR>

        <div id="loader"></div>
        <div id="error_alert" class="alert alert-danger" role="alert"></div>


        <!--用例基础信息form-->
        <button class="btn btn-primary" id="copy_use_case" onclick="copyUseCase(this)" value=""
                data-toggle="modal" data-target="#copyUseCaseModal" style="margin-right: 1%; float: right">复制</button>
        <form id="use_case_form" class="detail_form">
            <div class="form-group">
                <label for="use_case_id" style="display: none;">接口id</label>
                <input style="display: none;" type="text" class="form-control" id="use_case_id" placeholder=""
                       readonly>
            </div>
            <div class="form-group">
                <label for="use_case_name">用例名称</label>
                <input type="text" class="form-control" id="use_case_name" placeholder="用例名称" value="">
            </div>
            <div class="form-group">
                <label for="use_case_type">类型</label>
                <select id="use_case_type" class="form-control">
                    <option value="0">测试</option>                                                                                                                                                                                                                                                               +

                    <option value="1">巡检</option>
                </select>
            </div>
            <div class="form-group">
                <label for="use_case_desc">预置条件</label>
                <textarea type="text" class="form-control" id="pre_condition" rows="1" value=""></textarea>
            </div>
            <div class="form-group">
                <label for="use_case_desc">用例步骤</label>
                <textarea type="text" class="form-control" id="use_case_desc" rows="1" placeholder="用例步骤描述" value=""></textarea>
            </div>
            <div class="form-group">
                <label for="use_case_desc">预期结果</label>
                <textarea type="text" class="form-control" id="post_condition" rows="1" value=""></textarea>
            </div>
            <div id="business_line" class="input-select" style="display: none">
                <label for="business_line">业务线</label>
                <select id="business_name" class="select" onchange="input_value(this)">
                </select>
                <input id="input_business_name" class="input-text" type="text" onchange="init_input_value(st=this,id_name='business_id')" data-business_id="" value=""/>
            </div>
            <div id="system_line" class="input-select" style="display: none">
                <label for="system_name">系统线</label>
                <select id="system_name" class="select" onchange="input_value(this)">
                </select>
                <input id="input_system_name" class="input-text" type="text" onchange="init_input_value(st=this,id_name='system_id')" data-system_id="" value=""/>
            </div>
            <div class="input-select">
                <label for="function_name">功能模块</label>
                <select id="function_name" class="select" onchange="input_value(this)">
                </select>
                <input id="input_function_name" class="input-text" type="text" onchange="init_input_value(st=this,id_name='function_id')" data-function_id="" value=""/>
            </div>
            <div class="input-select">
                <label for="environment_name">环境路线</label>
                <select id="environment_name" class="select" onchange="input_value(this)">
                </select>
                <input id="input_environment" class="input-text" type="text" onchange="init_input_value(st=this,id_name='environment_id')" data-environment_id="" value=""/>
            </div>
        </form>
        <div id="use_case-option" style="margin-left: 25%">
            <button class="btn btn-primary" id="submit_use_case">提交</button>
            <button class="btn btn-danger" id="delete_use_case" data-toggle="modal" data-target="#delete_confirm" value="">删除</button>
            <button class="btn btn-success" id="run_use_case" data-toggle="modal" data-target="#execute_result">运行</button>
            <button class="btn btn-info" id="async_run_use_case" data-toggle="modal" data-target="#execute_background">异步运行</button>
        </div>

        <HR>
        <h6 id="interface_list_title" style="margin: 0 25%">
            用例接口列表
            <span class="badge badge-info float-right" data-toggle="modal"
                  data-target="#how_to_parameter">如何传递参数?</span>
            <span class="badge badge-info float-right" data-toggle="modal" data-target="#how_to_eval">如何验证接口?</span>
        </h6>

        <button id="add_interface_button" style="margin: 10px 25%;" type="button" class="btn btn-primary btn-sm"
                data-toggle="modal"
                data-target="#addInterfaceModal">
            新增接口
        </button>

        <div id="interface_alert" class="alert alert-danger" role="alert"></div>

        <!--用例包含接口列表-->
        <div class="accordion" id="use_case_interface_list"></div>

        <!--添加接口弹出框-->
        <div class="modal fade" id="addInterfaceModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
             aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">添加接口</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <input type="text" id="interface_search" onkeyup="interfaceSearch()" placeholder="搜索接口">
                        <!--所有接口列表-->
                        <ul class="list-group" id="interfaceUL" style="max-height: 300px; overflow-y:scroll;"></ul>
                    </div>
                    <div class="modal-footer">
                        <button type="button" name="cancel_add_interface" class="btn btn-secondary" data-dismiss="modal">取消</button>
                        <button type="button" name="add_interface" class="btn btn-primary" data-dismiss="modal">添加</button>
                    </div>
                </div>
            </div>
        </div>

        <!--删除接口弹出确认框-->
        <div class="modal fade" id="deleteInterfaceModal" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">删除接口</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <p>确认要删除吗？</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-danger" name="delete-interface-confirm-btn" data-dismiss="modal" value="">确认删除</button>
                    </div>
                </div>
            </div>
        </div>

        <!--复制用例-->
        <div class="modal fade" id="copyUseCaseModal" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">复制用例</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div style="border: black">
                        <input type="text" class="form-control" id="case_name" placeholder="用例名称" value="">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-danger" name="copy-use-case-confirm-btn" data-dismiss="modal" value="">确认</button>
                    </div>
                </div>
            </div>
        </div>

        <!--参数说明弹出-->
        <div class="modal fade" id="how_to_parameter" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
             aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="whatever">参数说明</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <p>有以下几种方式给用例中的接口指定预留参数进行替换:</p>
                        <p>1. &nbsp 固定值. 直接填入固定参数值, 如string_value1, 123</p>
                        <p>2. &nbsp 预先通过参数管理加入系统的固定参数. 通过${param|参数名}的方式表示, 如${param|username}表示预定义的叫username的参数</p>
                        <p>3. &nbsp 用例中其他接口的返回数据, 通过<br>
                            ${接口序号|接口数据}数据过滤<br>
                            表达. 接口数据支持status_code(状态码), header(包头), json_payload(json消息体)三种. <br>
                            如第二个接口返回{"head": {"a": 1}, "body": {"ret": 0}} 希望选择其消息体中ret参数传入, 则填写<br>
                            ${2|json_payload}["body"]["ret"]</p>
                        <p>4. &nbsp 支持随机数生成，即可以生成指定长度的整数串、字符串，如： <br>
                            random(11)表示生成11位长度的整型串;支持参数开头自定义，如random(11,'150')表示开头是150的数字串<br>
                            random(str,20)表示生成20位长度的字符串;支持参数开头自定义，如random(str,20,'abc')表示开头是abc的字符串<br>
                        </p>
                        <p>5. &nbsp 支持当前时间撮导入，格式如下：<br>
                            ${timestamps} 表示参数用当前时间的时间撮代替<br>
                        </p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <!--验证说明弹出-->
        <div class="modal fade" id="how_to_eval" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
             aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="whatever_eval">验证说明</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <p>接口返回验证方法为填入布朗表达式, 让后台根据填入的布朗表达式进行验证</p>
                        <p>布朗表达式中可使用${status_code}, ${header}, ${json_payload}分别指代返回的状态码, 包头, json消息体</p>
                        <p>布朗表达式中也可以使用各种布朗运算符, 如==(等于), !=(不等于), >=(大于等于), and, not, or等一切Python支持的布朗运算符</p>
                        <p>比如接口返回消息体为{"head": {"a": 1}, "body": {"ret": 0}}<br>
                            现希望确认此接口返回的状态码为200并且消息体中ret为0, 则可填写:<br>
                            ${status_code} == 200 and ${json_payload}["body"]["ret"] == 0</p>

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!--删除确认-->
    <div class="modal fade" id="delete_confirm" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">删除用例</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>确认要删除吗？</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-danger" data-dismiss="modal" name="delete-use-case-confirm-btn" value="">确认删除</button>
                </div>
            </div>
        </div>
    </div>


    <!--执行结果-->
    <div class="modal fade" id="execute_result" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">执行结果</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="execute_loader"></div>
                    <div id="execute_alert" class="alert alert-success" role="alert"></div>
                    <div id="execute_result_display" style="word-break:break-all;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                </div>
            </div>
        </div>
    </div>

    <!--异步执行提示-->
    <div class="modal fade" id="execute_background" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">异步执行</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>异步执行已提交，请去日志中查看执行结果。</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

</div>

<script src="/component/js/jquery-3.3.1.min.js"></script>
<script src="/component/js/popper.min.js"></script>
<script src="/component/js/bootstrap.min.js"></script>
<script src="/component/js/moment.min.js"></script>
<script src="/component/js/treeview.min.js"></script>
<script src="/js/cmm.js"></script>

<script>
    // 警告内容
    var menu_tree_data = null;
    var use_case_selected_data = null;
    var error_alert = $("#error_alert");
    var loader = $("#loader");
    var error_alert_use_case = $("#error_alert_use_case");
    var loader_use_case = $("#loader_use_case");
    var selector_list = $("#page-content-wrapper");
    var sidebar_selector = $('#sidebar-wrapper');
    var tree_selector = $('#menu_tree');
    var use_case_table_selector = $('#use_case-wrapper');
    var add_use_case_selector = $('#add_use_case');
    var active_order = 0; //添加用例接口顺序参数
    selector_list.hide();

    function show_alert(alert_text) {
        loader.hide();
        error_alert.text(alert_text);
        error_alert.show();
    }
    function show_alert_use_case(alert_text) {
        $("#head_line").hide();
        loader_use_case.hide();
        error_alert_use_case.text(alert_text);
        error_alert_use_case.show();
    }

    function escapeHtml(string) {
        var entityMap = {
            "&": "&amp;",
            "<": "&lt;",
            ">": "&gt;",
            '"': '&quot;',
            "'": '&#39;',
            "/": '&#x2F;'
        };
        return String(string).replace(/[&<>"'\/]/g, function (s) {
            return entityMap[s];
        });
    }

    function change_wraper_style(data, parentNode) {
        if (data.levels && data.levels > 3 && !data.state.expanded || data.levels >4) {
            sidebar_selector.attr('style',"width: 28%; max-width: 400px");
            selector_list.find('ol').attr('style', 'margin-left:20%');
            use_case_table_selector.removeAttr('style', 'margin-left:20%');
            use_case_table_selector.attr('style', 'margin-left:15%');
        } else if (!parentNode.state || !parentNode.state.expanded) {
            sidebar_selector.removeAttr('style',"width: 28%; max-width: 400px");
            selector_list.find('ol').removeAttr('style', 'margin-left:20%');
            use_case_table_selector.removeAttr('style', 'margin-left:15%');
        } else if (data.levels == 4 && data.state.expanded) {
            sidebar_selector.removeAttr('style',"width: 28%; max-width: 400px");
            selector_list.find('ol').removeAttr('style', 'margin-left:20%');
            use_case_table_selector.removeAttr('style', 'margin-left:15%');
        }
    }

    $.when(treeview_ajax()).then(function () {
        menu_tree_data = treeview_data[2];
        $('.add-use-case').hide();
        tree_selector.treeview({
            data: treeview_data,
            onNodeSelected: function (event, data) {
                $('#use_case_form').hide();
                $("#interface_list_title").show();
                $("#add_interface_button").show();
                $("#use_case_interface_list").show();
                if (data.text != '用例管理' && data.levels==1) {
                    getMapfromUrl(data);
                }else if (data.text == '用例管理'){
                    getMapfromUrl(data);
                }
                var parentNode = tree_selector.treeview('getParent', data.nodeId);
                if (data.state.expanded){
                    tree_selector.treeview('collapseNode', [data.nodeId, { silent: true }]);
                }else {
                    tree_selector.treeview('expandNode', [parentNode.nodeId]);
                    tree_selector.treeview('expandNode', [data.nodeId, { silent: true }]);
                }
                if (data.nodes && data.nodes.length > 0){
                    tree_selector.treeview('toggleNodeSelected', [data.nodeId]);
                }
                selector_list.hide();
                change_wraper_style(data, parentNode);
                switch (data.levels){
                    case 1:
                    case 2:
                    case 3:
                    case 4:
                        if (data.levels <3) {
                            add_use_case_selector.val('business_id-' + data.business_id);
                        } else if ( data.levels < 4) {
                            add_use_case_selector.val('system_id-' + data.system_id);
                        } else {
                            add_use_case_selector.val('function_id-' + data.function_id);
                        }
                        menu_tree_data = data;
                        if (data.levels > 1) {
                            filter_use_case_table(data);
                        }
                        use_case_table_selector.show();
                        window.history.pushState(null, null, '/use_case/1');
                        break;
                    case 5:
                        use_case_selected_data = data;
                        selector_list.show();
                        selector_list.find('#loader').show();
                        get_use_case_detail(data.use_case_id);
                        use_case_table_selector.hide();
                        select_function_line_append(data.function_id);
                        break;
                }
            }
        });
    });


    // 获取所有接口列表并放入接口添加列表
    $(document).ready(function () {
        $.ajax({
            type: 'post',
            url: '/interface/info',
            data: JSON.stringify({
                'pageIndex': 0,
                'pageSize': 0
            }),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (response) {
                if (!response.success) {
                    show_alert('获取数据失败');
                } else {
                    var interface_list = response.res;
                    $.each(interface_list, function (i, interface) {
                        $("#interfaceUL").append('<li data-value="' + interface.id + '" class="list-group-item">' + interface.interface_name + '</li>')
                    })
                }
            }
        })
    });

    // 接口添加列表搜索功能
    function interfaceSearch() {
        var input, filter, ul, li, item, i;
        input = document.getElementById('interface_search');
        filter = input.value.toUpperCase();
        ul = document.getElementById('interfaceUL');
        li = ul.getElementsByTagName('li');

        for (i = 0; i < li.length; i++) {
            item = li[i];
            if (item.innerHTML.toUpperCase().indexOf(filter) > -1) {
                item.style.display = "";
            } else {
                if (!item.classList.contains('active')) {
                    item.style.display = "none";
                }
            }
        }
    }
    function get_use_case_detail(use_case_id) {
        $('#page-content-wrapper').show();
        $('#delete_use_case').show();
        $('#run_use_case').show();
        $('#async_run_use_case').show();
        $('#use_case-wrapper').show();

        $("#interface_list_title").show();
        $("#add_interface_button").show();
        $("#use_case_interface_list").show();
        $("#use_case-wrapper").hide();
        $("#business_line").hide();
        $("#system_line").hide();
        $("#error_alert").hide();
        loader.show();
        $.ajax({
            type: 'post',
            url: '/use_case/detail',
            data: JSON.stringify({
                'id': use_case_id
            }),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (response) {
                if (!response.success) {
                    show_alert('获取数据失败');
                } else {
                    error_alert.hide();
                    var use_case_detail = response.res;

                    select_function_line_append(use_case_detail.function_id);
                    select_environment_line_append(use_case_detail.environment_id);
                    $("#copyUseCaseModal").val(use_case_detail.id);
                    $("#copy_use_case").val(use_case_detail.use_case_name);
                    $("#use_case_id").attr('placeholder', use_case_detail.id);
                    $("#delete_use_case").val(use_case_detail.id);
                    $("#use_case_name").val(use_case_detail.use_case_name);
                    $("#pre_condition").val(use_case_detail.pre_condition);
                    $("#use_case_desc").val(use_case_detail.desc);
                    $("#post_condition").val(use_case_detail.post_condition);
                    $("#use_case_type").val(use_case_detail.type);

                    var option_list = $("#use_case_type").find('option');
                    $.each(option_list, function (i, option) {
                        if (option.value === use_case_detail.type) {
                            option.selected = true
                        }
                    });

                    var row = 0;
                    var row2 = 0;
                    var row3 = 0;
                    if (use_case_detail.desc && use_case_detail.desc.length > 0) {
                        var line_list = use_case_detail.desc.match(/(\r\n)|(\n)/g || []);
                        if (!line_list || use_case_detail.desc.length<5) {
                            row = 0;
                        } else {
                            row = line_list.length;
                        }
                    }
                    $("#use_case_desc").attr('rows', row+1);
                    if (use_case_detail.pre_condition && use_case_detail.pre_condition.length > 0) {
                        line_list = use_case_detail.pre_condition.match(/(\r\n)|(\n)/g || []);
                        if (!line_list || use_case_detail.pre_condition.length<5) {
                            row2 = 0;
                        } else {
                            row2 = line_list.length;
                        }
                    }
                    $("#pre_condition").attr('rows', row2+1);
                    if (use_case_detail.post_condition && use_case_detail.post_condition.length > 0) {
                        line_list = use_case_detail.post_condition.match(/(\r\n)|(\n)/g || []);
                        if (!line_list || use_case_detail.post_condition.length<5) {
                            row3 = 0;
                        } else {
                            row3 = line_list.length;
                        }
                    }
                    $("#post_condition").attr('rows', row3+1);

                    var interface_list = use_case_detail.interface_list;
                    if (interface_list.length == 0) {
                        $("#interface_alert").text('此用例目前没有接口，请添加。');
                        $("#use_case_interface_list").empty();
                        $("#interface_alert").show()
                    } else {
                        $("#interface_alert").hide();
                        $("#use_case_interface_list").empty();
                        loader.show();
                        $.each(interface_list, function (i, interface_info) {
                            var interface_delay = interface_info.interface_delay;
                            var select_status = {
                                0: '0',
                                10: '10',
                                30: '30',
                                60: '60'
                            };
                            select_status[interface_delay] = ' selected=\"true\"';
                            var move_up_class = 'btn btn-info';
                            var move_down_class = 'btn btn-info';
                            if (interface_info.order == 1) {
                                move_up_class = 'btn btn-secondary disabled'
                            }
                            if (interface_info.order == interface_list.length) {
                                move_down_class = 'btn btn-secondary disabled'                            }
                            var interface_card = "<div class=\"card\">\n" +
                                "                <div class=\"card-header\" data-value=\"" + interface_info.id + "\" id=\"heading_" + interface_info.id + '\" data-use_case_id=\"' + use_case_id + "\">\n" +
                                "                    <h5 class=\"mb-0\">\n" +
                                "                        <button class=\"btn btn-link collapsed\" type=\"button\" data-toggle=\"collapse\"\n" +
                                "                                data-target=\"#collapse_" + interface_info.id + "\" aria-expanded=\"false\" aria-controls=\"collapse_" + interface_info.id + "\">\n" +
                                "                            " + (i+1) + ". " + interface_info.interface_name + "\n" +
                                "                        </button>\n" +
                                "                    </h5>\n" +
                                "                    <div>" +

                                "                    </div>"+
                                "                    <div class=\"btn-group btn-group-sm float-right\" data-order=\"" + interface_info.order + "\" role=\"group\" aria-label=\"Basic example\">\n" +

                                "                        <button type=\"button\" name=\"move_up\" class=\"move_up " + move_up_class + "\">上移</button>\n" +
                                "                        <button type=\"button\" name=\"move_down\" class=\"move_down " + move_down_class + "\">下移</button>\n" +
                                "                        <button type=\"button\" name=\"run_interface\" class=\"btn btn-info run_interface\" data-toggle=\"modal\" data-target=\"#execute_result\">运行</button>\n" +
                                "                        <button type=\"button\" name=\"edit_interface\" class=\"btn btn-info edit_interface\" data-toggle=\"modal\"><a href=\"/interface_detail/"+ interface_info.interface_id+'?relation_id='+interface_info.id+'&use_case_id='+ use_case_id +"\" style=\"background: #17a2b8;border-color:#17a2b8\;color:white\">编辑</a></button>\n" +
                                "                        <button type=\"button\" name=\"delete_interface\" class=\"btn btn-info delete_interface\" data-toggle=\"modal\" data-target=\"#deleteInterfaceModal\">删除</button>\n" +
                                "                        <select name=\"interface_delay\" class=\"interface_delay\">\n" +
                                "                                <option value=\"0\""+ select_status[0]+">正常模式</option>\n" +
                                "                                <option value=\"10\""+ select_status[10]+">延时10秒</option>\n" +
                                "                                <option value=\"30\""+ select_status[30]+">延时30秒</option>\n" +
                                "                                <option value=\"60\""+ select_status[60]+">延时1分钟</option>\n" +
                                "                        </select>\n" +
                                "                    </div>" +
                                "                </div>\n" +
                                "                <div id=\"collapse_" + interface_info.id + "\" class=\"collapse\" aria-labelledby=\"heading_" + interface_info.id + "\" data-parent=\"#accordion\" + a+\n" +
                                "                    <div class=\"card-body\">\n" +
                                "                        <form class='param_form'></form>" +
                                "                    </div>\n" +
                                "                </div>\n" +
                                "            </div>";
                            $("#use_case_interface_list").append(interface_card);
                            var param_list = interface_info.param_list;
                            $.each(param_list, function (i, param) {
                                if (param_list.length != 0) {
                                    var param_string = "<div class=\"form-group row\">\n" +
                                        "                                <label for=\"param_" + param.id + "\" class=\"col-sm-2 col-form-label\">" + escapeHtml(param.parameter_name) + "</label>\n" +
                                        "                                <div class=\"col-sm-10\">\n" +
                                        "                                    <input class=\"param_input\" type=\"text\" data-value=\"" + param.id + "\" class=\"form-control param_input\" id=\"param_" + param.id + "\" value='" + escapeHtml(param.parameter_value) + "'>\n" +
                                        "                                </div>\n" +
                                        "                            </div>";
                                    $("#use_case_interface_list").find('#collapse_' + interface_info.id).find('.param_form').append(param_string);
                                }
                            });
                            var eval_string = "<div class=\"form-group row\">\n" +
                                "                                <label for=\"eval_" + interface_info.id + "\" class=\"col-sm-2 col-form-label\">验证</label>\n" +
                                "                                <div class=\"col-sm-10\">\n" +
                                "                                    <input class=\"eval_input\" type=\"text\" data-value=\"" + interface_info.id + "\" class=\"form-control param_input\" id=\"eval_" + interface_info.id + "\" value='" + escapeHtml(interface_info.eval_string) + "'>\n" +
                                "                                </div>\n" +
                                "                            </div>";
                            $("#use_case_interface_list").find('#collapse_' + interface_info.id).find('.param_form').append(eval_string);
                            var button_string = "<button class=\"btn btn-sm btn-primary param_submit\" id=\"submit_param\">更新</button>";
                            $("#use_case_interface_list").find('#collapse_' + interface_info.id).find('.param_form').after(button_string);
                        });
                        loader.hide();
                    }
                    $("#use_case_form").show();
                    $("#submit_use_case").html('更新');
                    $("#submit_use_case").show();
                }
                loader.hide();
                var page_num = window.location.pathname.split('/').pop();
                window.history.pushState(null, null, '/use_case/'+ page_num +'?use_case_detail&use_case_id=' + use_case_id)
            }
        })

    }

    // 接口添加列表点击选中功能
    $(document).ready(function () {
        var ul = $("#interfaceUL");

        ul.on('click', 'li', function () {
            if(!$(this).hasClass("active")) {
                $(this).addClass('active');
                active_order +=1;
                $(this).data("order", active_order);
            } else {
                $(this).removeClass('active');
            }
        })
    });

    $(document).ready(function () {
        $('button[name="cancel_add_interface"]').click(function () {
            var selected_interface_list = $("#interfaceUL").find('.active');
            $.each(selected_interface_list, function (i, selected_interface) {
                $(selected_interface).removeClass("active");
            })
        })
    });

    // 添加接口到用例
    $(document).ready(function () {
        $('button[name="add_interface"]').click(function () {
            var selected_interface_list = $("#interfaceUL").find('.active');
            var use_case_id = $('#use_case_id').attr('placeholder');
            loader.show();
            if (selected_interface_list.length < 1) {
                get_use_case_detail(use_case_id);
            } else {
                var interface_arr = [];
                $.each(selected_interface_list, function (i, selected_interface) {
                    var selected_interface_id = $(selected_interface).data('value');
                    var order = $(selected_interface).data('order');
                    interface_arr[order] = selected_interface_id;
                    $(selected_interface).removeClass("active");

                });
                active_order = 0;
                $.ajax({
                    type: 'post',
                    url: '/use_case/relation/add',
                    data: JSON.stringify({
                        'use_case_id': use_case_id,
                        'interface_id': interface_arr
                    }),
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (response) {
                        if (!response.success) {
                            show_alert('更新数据失败')
                        } else {
                            get_use_case_detail(use_case_id);
                        }
                    }
                });
            }
        })
    });

    //添加或更新用例基本信息
    $(document).ready(function () {
        $("#submit_use_case").click(function () {
            var business_id = $("#input_business_name").data('business_id');
            var system_id = $("#input_system_name").data('system_id');
            var function_id = $("#input_function_name").data('function_id');
            var environment_id = $("#input_environment").data("environment_id");
            var use_case_id = $("#use_case_id").attr('placeholder');
            var pre_condition = $("#pre_condition").val();
            var url = '/use_case/add';
            var use_case_dict = {
                'use_case_name': $("#use_case_name").val(),
                'use_case_type': $("#use_case_type").val(),
                'pre_condition': pre_condition,
                'desc': $("#use_case_desc").val(),
                'post_condition': $("#post_condition").val(),
                'function_id': function_id,
                'environment_id': environment_id
            };
            $("#error_alert").hide();
            if (!use_case_id) {
                var init_menu_tree_data = {
                    business_id: business_id,
                    system_id: system_id,
                    function_id: function_id,
                    business_name: $("#input_business_name").val(),
                    system_name: $("#input_system_name").val(),
                    function_name: $("#input_function_name").val()
                };
                if (!init_menu_tree_data.business_name) {
                    show_alert("业务目录不能为空!")
                } else if (!init_menu_tree_data.system_name) {
                    show_alert("系统目录不能为空!")
                } else if (!init_menu_tree_data.function_name) {
                    show_alert("功能目录不能为空!")
                } else {
                    $.ajax({
                        type: 'post',
                        url: '/menu_tree/use_case/add',
                        data:JSON.stringify(init_menu_tree_data),
                        contentType: "application/json; charset:utf-8",
                        dataType:"json",
                        success: function (response) {
                            if (!response.success) {
                                show_alert('创建目录失败：'+ response.error);
                            } else {
                                var result = response.res;
                                use_case_dict.function_id = result.function_id;
                                add_update_use_case(url, use_case_dict)
                            }
                        }
                    })
                }
            } else {
                url = '/use_case/update';
                use_case_dict.id = use_case_id;
                add_update_use_case(url, use_case_dict)
            }
        })
    });
    function add_update_use_case(url, use_case_dict) {
        $.ajax({
            type: 'post',
            url: url,
            data: JSON.stringify(
                use_case_dict
            ),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (response) {
                if (!response.success) {
                    show_alert('更新数据失败:' + response.error);
                } else {
                    if (url==='/use_case/add') {
                        var use_case_id = response.res;
                        get_use_case_detail(use_case_id)
                    } else {
                        get_use_case_detail(use_case_dict.id)
                    }
                }
            }
        })
    }

    // 更新用例传给接口的数据
    $(document).ready(function () {
        $("#use_case_interface_list").on('click', '.param_submit', function () {
            var card = $(this).closest('.card');
            var param_list = card.find(".param_input");
            loader.show();
            $.each(param_list, function (i, param) {
                var id_to_update = param.dataset.value;
                $.ajax({
                    type: 'post',
                    url: '/use_case/relation/parameter/modify',
                    data: JSON.stringify({
                        'id': id_to_update,
                        'parameter_value': param.value
                    }),
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function () {
                    }
                })
            });
            var eval_input = card.find(".eval_input");
            var id_to_update = eval_input.data('value');
            var eval_string = eval_input.val();
            $.ajax({
                type: 'post',
                url: '/use_case/relation/update_eval',
                data: JSON.stringify({
                    'id': id_to_update,
                    'eval_string': eval_string
                }),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (response) {
                    if (!response.success) {
                        show_alert('更新数据失败');
                    } else {
                        loader.hide();
                        // get_use_case_detail($("#use_case_id").attr('placeholder'))
                    }
                }
            })
        })
    });

    $(document).ready(function () {
       $('button[name="copy-use-case-confirm-btn"]').click(function () {
           let use_case_id = $("#use_case_interface_list").find('.card-header').data('use_case_id');
           let copy_use_case_name = $("#case_name").val();
           loader.show();
           $.ajax({
               type: 'post',
               url: '/use_case/detail',
               data: JSON.stringify({
                   'id': use_case_id
               }),
               contentType: "application/json; charset=utf-8",
               dataType: "json",
               success: function (response) {
                   if (!response.success) {
                       show_alert('获取数据失败');
                   } else {
                       error_alert.hide();
                       let use_case_detail = response.res;
                       $.ajax({
                           type: 'post',
                           url: '/use_case/add',
                           data: JSON.stringify({
                               'environment_id': use_case_detail['environment_id'],
                               'use_case_name': copy_use_case_name,
                               'use_case_type': use_case_detail['type'],
                               'pre_condition': use_case_detail['pre_condition'],
                               'desc': use_case_detail['pre_condition'],
                               'post_condition': use_case_detail['post_condition'],
                               'function_id': use_case_detail['function_id']
                           }),
                           contentType: "application/json; charset=utf-8",
                           dataType: "json",
                           success: function (response) {
                               if (!response.success) {
                                   show_alert('复制用例失败');
                               } else {
                                   let copy_use_case_id = response.res;
                                   $.ajax({
                                       type: 'post',
                                       url: '/use_case/copy/interface',
                                       data: JSON.stringify({
                                           use_case_id: copy_use_case_id,
                                           interface_list: use_case_detail.interface_list
                                       }),
                                       success: function (response) {
                                           if (!response.success) {
                                               show_alert('用例关联接口失败');
                                           } else {
                                               window.location.href = '/use_case/1'
                                           }
                                       }
                                   })
                               }
                           }
                       })
                   }
               }
           });
       })
    });

    // 预删除接口
    $(document).ready(function () {
        $("#use_case_interface_list").on('click', '.delete_interface', function () {
            var to_delete = $(this).closest('.card-header').data('value');
            var delete_button = $('button[name="delete-interface-confirm-btn"]');
            delete_button.val(to_delete)
        })
    });

    // 删除接口
    $(document).ready(function () {
        $('button[name="delete-interface-confirm-btn"]').click(function () {
            var id_to_delete = $(this).val();
            var use_case_id = $("#use_case_interface_list").find('.card-header').data('use_case_id');
            $.ajax({
                type: 'post',
                url: '/use_case/relation/delete',
                data: JSON.stringify({
                    'id': id_to_delete
                }),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (response) {
                    if (!response.success) {
                        show_alert('删除失败')
                    } else {
                        get_use_case_detail(use_case_id);
                    }
                }
            })
        })
    });

    // 上移
    $(document).ready(function () {
        $("#use_case_interface_list").on('click', '.move_up', function () {
            if (!$(this).hasClass('disabled')) {
                var relation_id = $(this).closest('.card-header').data('value');
                var current_order = $(this).closest('.btn-group').data('order');
                var use_case_id = $(this).closest('.card-header').data('use_case_id');
                $.ajax({
                    type: 'post',
                    url: '/use_case/relation/reorder',
                    data: JSON.stringify({
                        'id': relation_id,
                        'new_order': current_order - 1
                    }),
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (response) {
                        if (!response.success) {
                            show_alert('更新数据失败')
                        } else {
                            get_use_case_detail(use_case_id)
                        }
                    }
                })
            }
        })
    });

    // 下移
    $(document).ready(function () {
        $("#use_case_interface_list").on('click', '.move_down', function () {
            if (!$(this).hasClass('disabled')) {
                var relation_id = $(this).closest('.card-header').data('value');
                var current_order = $(this).closest('.btn-group').data('order');
                var use_case_id = $(this).closest('.card-header').data('use_case_id');
                $.ajax({
                    type: 'post',
                    url: '/use_case/relation/reorder',
                    data: JSON.stringify({
                        'id': relation_id,
                        'new_order': current_order + 1
                    }),
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (response) {
                        if (!response.success) {
                            show_alert('更新数据失败')
                        } else {
                            get_use_case_detail(use_case_id)
                        }
                    }
                })
            }
        })
    });

    // 预删除动作
    $(document).ready(function () {
        $("#wrapper").on('click', 'button', function () {
            var to_delete = $(this).val();
            var delete_button = $('button[name="delete-use-case-confirm-btn"]');
            delete_button.val(to_delete)
        })
    });

    // 确认删除
    $(document).ready(function () {
        $('button[name="delete-use-case-confirm-btn"]').click(function () {
            var id_to_delete = $(this).val();
            loader.show();
            $.ajax({
                type: 'post',
                url: '/use_case/delete',
                data: JSON.stringify({
                    'id': id_to_delete
                }),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (response) {
                    if (!response.success) {
                        show_alert('删除接口失败');
                    } else {
                        // treeview_ajax();
                        $.when(treeview_ajax()).then(function () {
                            if (use_case_selected_data && use_case_selected_data.levels > 4 || menu_tree_data.levels <= 1) {
                            window.location.href = '/use_case/1'
                            }
                            filter_use_case_table(menu_tree_data, id_to_delete)
                        })
                    }
                }
            })
        })
    });

    // 运行接口
    $(document).ready(function () {
        $("#use_case_interface_list").on('click', '.run_interface', function () {
            var run_relation_id = $(this).closest('.card-header').data('value');
            var use_case_id = $(this).closest('.card-header').data('use_case_id');
            run_use_case(use_case_id, run_relation_id)
        })
    });

    function show_execute_alert(alert_text, class_name) {
        var execute_alert = $("#execute_alert");
        execute_alert.text(alert_text);
        execute_alert.removeClass('alert-success');
        execute_alert.removeClass('alert-danger');
        execute_alert.removeClass('alert-warning');
        execute_alert.addClass(class_name);
        execute_alert.show();
    }

    $(document).ready(function () {
        $("#wrapper").on('click', 'button', function () {
            var use_case_id = '';
            if (this.name === 'table_run_use_case' || this.id === 'run_use_case'){
                use_case_id = this.value;
                if (this.id === 'run_use_case') {
                    use_case_id = $('#use_case_id').attr('placeholder');
                }
                run_use_case(use_case_id)
            } else if(this.name === 'table_async_run_use_case' || this.id === 'async_run_use_case') {
                use_case_id = this.value;
                if (this.id === 'async_run_use_case') {
                    use_case_id = $('#use_case_id').attr('placeholder');
                }
                asyc_run_use_case(use_case_id)
            } else if (this.name === 'table_detail_use_case') {
                get_use_case_detail(this.value)
            }
        });

        $("#use_case_interface_list").on('change', '.interface_delay', function () {
            var interface_delay = this.value;
            var relation_id = $(this).closest('.card-header').data('value');
            $.ajax({
                type: 'post',
                url: '/use_case/relation/update/interface_delay',
                data: JSON.stringify({
                    id: relation_id,
                    interface_delay: interface_delay
                }),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (response) {
                    if (!response.success) {
                        error_alert("更新失败，请重试")
                    }

                }
            })
        })
    });

    // 执行
    function run_use_case(use_case_id, run_relation_id=null){
        var execute_result_display = $("#execute_result_display");
        var environment_id = $("#input_environment").data('environment_id');
        execute_result_display.empty();
        $("#execute_loader").show();
        $("#execute_alert").hide();
        $.ajax({
            type: 'post',
            url: '/use_case/execute',
            data: JSON.stringify({
                id: use_case_id,
                environment_id: environment_id,
                relation_id:run_relation_id
            }),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (response) {
                $("#execute_loader").hide();
                var success = 'Pass';
                var color = 'green';
                if (!response.success) {
                    show_execute_alert(response.error_str + '执行失败', 'alert-danger');
                    execute_result_display.append('<h5>错误信息：</h5>');
                    execute_result_display.append('<p>' + response.error + '</p>');
                    var execute_result_list = response.res;

                    $.each(execute_result_list, function (i, result) {
                        if (!result.success) {
                            success = 'Fail';
                            color = 'red'
                        }
                        execute_result_display.append('<h5>' + (i+1) + '.' +  result.interface_name +'</h5>');
                        execute_result_display.append('<p style="color:'+color+ ';font-weight: bolder">运行结果：' + success  + '</p>');
                        execute_result_display.append('<p><b>返回状态码：</b>' + result.status_code + '</p>');
                        execute_result_display.append('<p><b>返回包头：</b>' + JSON.stringify(result.header) + '</p>');
                        var result_payload = "";
                        if (result.header['Content-Type'].indexOf("text/html") > -1 && JSON.stringify(result.json_response).indexOf("<iframe") >-1) {
                            result_payload = result.json_response
                            execute_result_display.append('<p><b>返回html：</b></p>' + result_payload);
                        } else {
                            result_payload = syntaxHighlight(result.json_response);
                            execute_result_display.append('<b>返回json：</b><pre>' + result_payload + '</pre>');
                        }
                    })
                } else {
                    $("#execute_loader").hide();
                    if (response.res.pass) {
                        show_execute_alert('执行通过', 'alert-success');
                    } else {
                        show_execute_alert('执行不通过', 'alert-warning');
                    }
                    execute_result_list = response.res.res;
                    $.each(execute_result_list, function (i, result) {
                        if (!result.success) {
                            success = 'Fail';
                            color = 'red'
                        }
                        execute_result_display.append('<h5>' + (i+1) + '.' +  result.interface_name +'</h5>');
                        execute_result_display.append('<p style="color:'+color+ ';font-weight: bolder">运行结果：' +  success + '</p>');
                        if (success == 'Fail') {
                            execute_result_display.append('<p style="color:'+color+ ';font-weight: bolder">失败原因：接口验证失败</p>');
                        }

                        execute_result_display.append('<p><b>返回状态码：</b>' + result.status_code + '</p>');
                        execute_result_display.append('<p><b>返回包头：</b>' + JSON.stringify(result.header) + '</p>');
                        var result_payload = "";
                        if (result.header['Content-Type'].indexOf("text/html") > -1 && JSON.stringify(result.json_response).indexOf("iframe") >-1) {
                            result_payload = result.json_response;
                            execute_result_display.append('<p><b>返回html：</b></p>' + result_payload);
                        } else {
                            result_payload = syntaxHighlight(result.json_response);
                            execute_result_display.append('<b>返回json：</b><pre>' + result_payload + '</pre>');
                        }
                    })
                }
            },
            error: function (event, errtext) {
                console.log(errtext);
                $("#execute_loader").hide();
                show_execute_alert("请求超时，请到日志中查看用例运行结果！",'alert-danger');

            },
        })
    }

    // 提交异步执行
    function asyc_run_use_case(use_case_id) {
        var environment_id = $("#input_environment").data('environment_id');
        $.ajax({
            type: 'post',
            url: '/use_case/execute/background',
            data: JSON.stringify({
                id: use_case_id,
                environment_id:environment_id
            }),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function () {
            }
        })

    }


    function filter_use_case_table(data, del_use_case_id=null) {
        error_alert_use_case.hide();
        selector_list.hide();
        $(".pagination").hide();
        $("#head_line").hide();
        let use_case_info = get_use_case_info(data);
        $("#use_case_table").find('tbody').empty();
        if (use_case_info.length <= 0) {
            $("#use_case_table").hide();
            $("#head_line").show();
            show_alert_use_case('没有找到相关用例')
        }
        else if (use_case_info.use_case_list.length <= 0) {
            $("#use_case_table").hide();
            show_alert_use_case('没有找到相关用例')
        } else {
            $("#use_case_name").val(null);
            $("#use_case_desc").val(null);
            $("#use_case_id").attr('placeholder', '');
            $("#use_case_table").show();

            var use_case_list = use_case_info.use_case_list;
            var create_by = '';
            var del_flag = false;
            var del_use_case_info = null;
            $.each(use_case_list, function (i, use_case) {
                create_by = use_case.create_by;
                let use_case_type = use_case.type;
                if (create_by == 1) {
                    create_by = "admin"
                } else {
                    create_by = use_case.create_by;
                }
                if (use_case_type===1) {
                    use_case_type = '巡检'
                } else {
                    use_case_type = '测试'
                }

                if (use_case.use_case_id != del_use_case_id || !del_use_case_id) {
                    var button_col = '<div class="btn-group btn-group-sm" role="group">' +
                        '<button name="table_detail_use_case" type="button" class="btn btn-info btn-secondary" value="' + use_case.use_case_id + '" data-toggle="modal">详情</button>' +
                        '<button name="table_run_use_case" type="button" class="btn btn-info btn-secondary execute-button" value="' + use_case.use_case_id + '" data-toggle="modal" data-target="#execute_result">执行</button>' +
                        '<button name="table_async_run_use_case" type="button" class="btn btn-info btn-secondary execute-background" value="' + use_case.use_case_id + '" data-toggle="modal" data-target="#execute_background">异步执行</button>' +
                        '<button name="delete_use_case_in_table" type="button" class="btn btn-info btn-secondary delete-button" value="' + use_case.use_case_id + '" data-toggle="modal" data-target="#delete_confirm">删除</button>';
                    $("#use_case_table").find('tbody')
                        .append('<tr>' +
                            '<th scope="row">' + (i + 1) + '</th>' +
                            '<td>' + use_case.text.split('.')[1] + '</td>' +
                            '<td>' + use_case_type + '</td>' +
                            '<td>' + create_by + '</td>' +
                            '<td>' + moment(use_case.update_time).format('YYYY/MM/DD HH:mm:ss') + '</td>' +
                            '<td>' + use_case_info.text.split('(')[0] + '</td>' +
                            '<td>' + button_col + '</td></tr>')
                } else {
                    del_flag = true;
                    del_use_case_info = use_case;
                }
            });
            if (del_flag && del_use_case_info) {
                use_case_list.splice($.inArray(del_use_case_info,use_case_list),1)
            }
        }
    }


    function get_use_case_info(data) {
        let use_case_list = [];
        let nodes_info = data.nodes;
        if (nodes_info.length < 1)
            return nodes_info;
        let start_case = data.levels + 1;
        switch (start_case) {
            case 3:
                $.each(nodes_info, function (i, node) {
                    if (node.nodes.length > 0) {
                        $.each(node.nodes, function (j, child_node) {
                            if (child_node.nodes.length > 0) {
                                use_case_list = use_case_list.concat(child_node.nodes)
                            }
                        })
                    }
                });
                break;
            case 4:
                $.each(nodes_info, function (i, node) {
                    if (node.nodes.length > 0) {
                        use_case_list = use_case_list.concat(node.nodes)
                    }
                });
                break;
            case 5:
                use_case_list = use_case_list.concat(nodes_info);
                break
        }
        return {'use_case_list': use_case_list, 'text': data.text}
    }

    $(document).ready(function () {
        $('#add_use_case').click(function () {
            $("#input_business_name").data("business_id", null);
            $("#input_system_name").data("system_id", null);
            $("#input_function_name").data("function_id", null);
            $("#pre_condition").val("");
            $("#post_condition").val("");
            $("#input_business_name").val("");
            $("#input_system_name").val("");
            $("#input_function_name").val("");
            $('#delete_use_case').hide();
            $('#run_use_case').hide();
            $('#async_run_use_case').hide();
            $('#use_case-wrapper').hide();

            $("#interface_list_title").hide();
            $("#add_interface_button").hide();
            $("#use_case_interface_list").hide();
            selector_list.show();
            selector_list.find('#loader').show();
            $("#use_case_form").show();
            $("#submit_use_case").html('提交');
            $("#submit_use_case").show();

            //添加对应菜单下拉框
            select_business_line_append();
            select_system_line_append();
            select_function_line_append();
            select_environment_line_append();

            loader.hide();
            $("#interface_alert").hide();

            $("#business_line").show();
            $("#system_line").show();
            $("#error_alert").hide();
            error_alert.hide();
        })
    });

    function select_business_line_append(business_line_id=null) {
        $("#business_name").empty();
        $.ajax({
            type: 'post',
            url: '/menu_tree/business_line/info',
            data: JSON.stringify({
            }),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (response) {
                var business__info_list = response.res;
                var append_str = '<option data-business_id="0" selected="true"></option>';
                if (business_line_id) {
                    append_str = '';
                }
                if (business__info_list.length > 0) {
                    $.each(business__info_list, function (i, business__info) {
                        append_str += '<option data-business_id="' + business__info.id + '">' + business__info.business_name + '</option>';
                    });
                    $("#business_name").append(append_str)
                }
            }
        });
    }

    function select_system_line_append(system_line_id=null, business_line_id=null) {
        $("#system_name").empty();
        if (!business_line_id) {
            return
        }

        $.ajax({
            type: 'post',
            url: '/menu_tree/system_line/info',
            data: JSON.stringify({
                business_line_id: business_line_id
            }),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (response) {
                var system__info_list = response.res;
                var append_str = '<option data-system_id="0"></option>';
                if (system_line_id) {
                    append_str = '';
                    $("#input_system_name").val("");
                    $("#input_system_name").data("system_id", 0);
                }
                if (system__info_list.length > 0) {
                    $.each(system__info_list, function (i, system__info) {
                        if (system__info.id == system_line_id) {
                            $("#input_system_name").data("system_id", system__info.id);
                            $("#input_system_name").val(system__info.system_name);
                            append_str += '<option data-system_id="' + system__info.id + '" selected="true">' + system__info.system_name + '</option>';
                        } else {
                            append_str += '<option data-system_id="' + system__info.id + '">' + system__info.system_name + '</option>';
                        }
                    });
                    $("#system_name").append(append_str)
                }
            }
        });
    }

    function select_environment_line_append(environment_id) {
        $("#environment_name").empty();
        $.ajax({
            type: 'post',
            url: '/environment/line/detail',
            data: JSON.stringify({
            }),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (response) {
                var environment_list = response.res;
                var append_str = '<option data-environment_id="0"></option>';
                if (!environment_id) {
                    append_str = '<option data-environment_id="0" selected="true"></option>';
                    $("#input_environment").val("");
                    $("#input_environment").data("environment_id", 0);
                }
                if (environment_list.length > 0) {
                    $.each(environment_list, function (i, environment_info) {
                        if (environment_info.id == environment_id) {
                            $("#input_environment").data('environment_id', environment_info.id);
                            $("#input_environment").val(environment_info.environment_name);
                            append_str += '<option selected="true" data-environment_id="' + environment_info.id + '">' + environment_info.environment_name + '</option>';
                        } else {
                            append_str += '<option data-environment_id="' + environment_info.id + '">' + environment_info.environment_name + '</option>';
                        }
                    });
                    $("#environment_name").append(append_str)
                }
            }
        });
    }

    function select_function_line_append(function_line_id=null, system_line_id=null) {

        if (!system_line_id && !function_line_id) {
            return
        }
        $.ajax({
            type: 'post',
            url: '/menu_tree/function_line/info',
            data: JSON.stringify({}),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (response) {
                var function_list = response.res;
                var append_str = '<option data-function_id="0"  value=""></option>';
                if (function_line_id) {
                    append_str = '';
                    $("#input_function_name").val("");
                    $("#input_function_name").data("function_id", '0');
                }
                $.each(function_list, function (i, function_info) {
                    if(system_line_id && (system_line_id === function_info.system_line_id)){
                        let menu_str = function_info.business_name + '->' + function_info.system_name + '->' + function_info.function_name;
                        if (function_info.function_line_id == function_line_id) {
                            $("#input_function_name").data("function_id", function_info.function_line_id);
                            $("#input_function_name").val(menu_str);
                            append_str += '<option data-function_id="' + function_info.function_line_id + '" value="' + function_info.function_line_id + '" selected="true">' + menu_str + '</option>';
                        } else if (function_info.function_line_id > 0) {
                            append_str += '<option data-function_id="' + function_info.function_line_id + '" value="' + function_info.function_line_id + '">' + menu_str + '</option>';
                        }

                    } else if (!system_line_id) {
                        let menu_str = function_info.business_name + '->' + function_info.system_name + '->' + function_info.function_name;
                        if (function_info.function_line_id == function_line_id) {
                            $("#input_function_name").data("function_id", function_info.function_line_id);
                            $("#input_function_name").val(menu_str);
                            append_str += '<option data-function_id="' + function_info.function_line_id + '" value="' + function_info.function_line_id + '" selected="true">' + menu_str + '</option>';
                        } else if (function_info.function_line_id > 0) {
                            append_str += '<option data-function_id="' + function_info.function_line_id + '" value="' + function_info.function_line_id + '">' + menu_str + '</option>';
                        }
                    }
                });
                $("#function_name").empty();
                $("#function_name").append(append_str)
            }
        });
    }

    $(document).ready(function () {
        $("#system_line").change(function () {
            var input_select=$(this).val();
            var option_length=$("option").length;
            var eq_flag = false;
            for(var i=0;i<option_length;i++){
                var option_id = $("option").eq(i).data();
                var option_value = $("option").eq(i).val();
                if(input_select==option_value){
                    $(this).data(option_id);
                    eq_flag = true;
                    break;
                }
            }
            if (!eq_flag) {
                $(this).data('system_id', null);
            }

            var system_id = $("#input_system_name").data('system_id');
            $("#input_function_name").val("");
            $("#input_function_name").data("function_id", '0');
            select_function_line_append(null, system_id);

        })
    });

    $(document).ready(function () {
        $("#business_line").change(function () {
            var business_id = $("#input_business_name").data('business_id');
            $("#input_system_name").val("");
            $("#input_system_name").data("function_id", '0');
            select_system_line_append(null, business_id);
        })
    });

    $(document).ready(function () {
        selector_list.hide();
        $.ajax({
            type: 'get',
            url: '/use_case/count',
            success: function (response) {
                var pagesize = 20;
                if (!response.success) {
                    show_alert('获取用例失败');
                } else if (response.res == 0) {
                    show_alert('没有用例数据，请新增')
                } else {
                    var total_use_case = response.res;
                    var page_num = window.location.pathname.split("/").pop();
                    var total_page = Math.ceil(total_use_case / pagesize);
                    if (page_num > total_page || page_num <= 0 || isNaN(page_num)) {
                        show_alert('无此页数据');
                    } else {
                        var previous_page = $('li[id="previous_page"]');
                        var next_page = $('li[id="next_page"]');
                        if (total_page == 1) {
                            previous_page.addClass('disabled');
                            next_page.addClass('disabled')
                        }
                        else if (page_num == 1) {
                            previous_page.addClass('disabled');
                            next_page.find('.page-link').attr('href', '/use_case/' + (Number(page_num) + 1))
                        } else if (page_num == total_page) {
                            next_page.addClass('disabled');
                            previous_page.find('.page-link').attr('href', '/use_case/' + (Number(page_num) - 1))
                        } else {
                            next_page.find('.page-link').attr('href', '/use_case/' + (Number(page_num) + 1));
                            previous_page.find('.page-link').attr('href', '/use_case/' + (Number(page_num) - 1))
                        }
                        var page_item_string = '';
                        var pre_page_item_string = '';
                        var after_page_item_string = '';
                        for (var i = 1; i <= total_page; i++) {
                            if (i == page_num) {
                                page_item_string += '<li class="page-item active"><a class="page-link" href="/use_case/' + i + '">' + i + '</a></li>'
                            } else if (i>page_num && i-page_num >3){
                                pre_page_item_string = '<li class="page-item"><a class="page-link" href="/use_case/'+(Number(page_num)+4)+'">...</a></li>';
                            } else if ( i < page_num && page_num - i >3 ){
                                after_page_item_string = '<li class="page-item"><a class="page-link" href="/use_case/'+(Number(page_num)-4)+'">...</a></li>'
                            } else {
                                page_item_string += '<li class="page-item"><a class="page-link" href="/use_case/' + i + '">' + i + '</a></li>'
                            }
                        }
                        if (pre_page_item_string){
                            page_item_string = page_item_string + pre_page_item_string
                        }
                        if (after_page_item_string){
                            page_item_string = after_page_item_string + page_item_string
                        }
                        var first_page_disabled_str = '';
                        var last_page_disabled_str = '';
                        if (page_num == 1) {
                            first_page_disabled_str = ' disabled';
                            if (page_num == total_page) {
                                last_page_disabled_str = ' disabled'
                            }
                        }else if (page_num == total_page){
                            last_page_disabled_str = ' disabled'
                        }
                        var first_page_string = '<li class="page-item'+ first_page_disabled_str +'" id="first_page"><a class="page-link" href="/use_case/1">首页</a></li>';
                        var last_page_string = '<li class="page-item'+ last_page_disabled_str +'" id="last_page"><a class="page-link" href="/use_case/'+ total_page +'">尾页</a></li>';
                        var data_page_string = '<p class="page-data" data-page-text="">第'+page_num+'页/共'+ total_page +'页</p>';
                        previous_page.before(first_page_string);
                        previous_page.after(page_item_string);
                        next_page.after(data_page_string);
                        next_page.after(last_page_string);
                        $('#jump_page').attr('data-page_num', page_num);

                        $.ajax({
                            type: 'post',
                            url: '/use_case/list',
                            data: JSON.stringify({
                                'pageSize': 20, // 表示查询所有
                                'pageIndex': page_num
                            }),
                            contentType: "application/json; charset=utf-8",
                            dataType: "json",
                            success: function (response) {
                                if (!response.success) {
                                    show_alert('获取数据失败')
                                } else {
                                    loader.hide();
                                    $("#use_case_table").show();
                                    var use_case_list = response.res;
                                    $.each(use_case_list, function (i, use_case) {
                                        var create_name = use_case.create_by;
                                        let use_case_type = use_case.type;
                                        if (create_name == 1) {
                                            create_name = 'admin'
                                        }
                                        if (use_case_type === 1) {
                                            use_case_type = '巡检'
                                        } else {
                                            use_case_type = '测试'
                                        }
                                        var button_col = '<div class="btn-group btn-group-sm" role="group">' +
                                            '<button name="table_detail_use_case" type="button" class="btn btn-info btn-secondary" value="' + use_case.id + '" data-toggle="modal">详情</button>' +
                                            '<button name="table_run_use_case" type="button" class="btn btn-info btn-secondary execute-button" value="' + use_case.id + '" data-toggle="modal" data-target="#execute_result">执行</button>' +
                                            '<button name="table_async_run_use_case" type="button" class="btn btn-info btn-secondary execute-background" value="' + use_case.id + '" data-toggle="modal" data-target="#execute_background">异步执行</button>' +
                                            '<button name="delete_use_case_in_table"  type="button" class="btn btn-info btn-secondary delete-button" value="' + use_case.id + '" data-toggle="modal" data-target="#delete_confirm">删除</button>';
                                        $("#use_case_table").find('tbody')
                                            .append('<tr>' +
                                                '<th scope="row">' + (pagesize * (page_num - 1) + i + 1) + '</th>' +
                                                '<td>' + use_case.use_case_name + '</td>' +
                                                '<td>' + use_case_type + '</td>' +
                                                '<td>' + create_name + '</td>' +
                                                '<td>' + moment(use_case.update_time).format('YYYY/MM/DD HH:mm:ss') + '</td>' +
                                                '<td>用例管理</td>' +
                                                '<td>' + button_col + '</td></tr>')
                                    })
                                }
                                var time_string = new URLSearchParams(window.location.search);
                                var use_case_id = time_string.get('use_case_id');
                                if (use_case_id) {
                                    get_use_case_detail(use_case_id)
                                }
                            }
                        })
                    }
                }
            }
        })
    });

    $(document).ready(function($) {
        if (window.history && window.history.pushState) {
            $(window).on('popstate', function() {
                var page_num = window.location.pathname.split('/').pop();
                var time_string = new URLSearchParams(window.location.search);
                var info = time_string.get('info');
                if (info !== 'detail') {
                    var hash = window.location.hash;
                    if (hash === '') {
                        window.location.href='/use_case/'+ page_num;
                    }
                }
            });
        }
    });

</script>
</body>
</html>